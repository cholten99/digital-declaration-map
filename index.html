<html>
  <head>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script src="https://cdn.sobekrepository.org/includes/gmaps-markerwithlabel/1.9.1/gmaps-markerwithlabel-1.9.1.min.js"></script>

    <style>
      .map_tooltip {
        color: red;
        background-color: white;
        font-family: "Lucida Grande", "Arial", sans-serif;
        font-size: 10px;
        font-weight: bold;
        text-align: center;
        width: 65px;     
        border: 2px solid black;
        white-space: nowrap;
      }
    </style>

    <script>
      $(document).ready(function(){

        // The map object
        var map;

        // The master list of data
        var master_list = Array();

        // Create the map
        function createMap() {
          // Get the canvas element
          var mapCanvas = document.getElementById('map-canvas');

          // Set up the map options
          var mapOptions = {
            center: new google.maps.LatLng(53.78, -3.85),
            zoom: 6,
            streetViewControl: false,
            mapTypeControl: false,
            mapTypeId: google.maps.MapTypeId.ROADMAP
          }

          // Create the map
          map = new google.maps.Map(mapCanvas, mapOptions)

          // Add a polygon for each local authority that has signed the Declaration
          for (i = 0; i < master_list.length; i++) {

            if ((master_list[i].declared === "Yes") && (master_list[i].geometry != null)) {
              poly = new google.maps.Polygon({
                paths: master_list[i].geometry,
                fillColor: "#0000ff",
                fillOpacity: 0.25,
                strokeWeight: 0.05
              });
              poly.setMap(map);

              // Add mouse-over tooltip for LA Declaration details
              var when = new Date(master_list[i].when);
label_content = "<img src='" + master_list[i].logoURL + "' height='60px'><p>Made by: " + master_list[i].who + "<br>On: " + when.toDateString();
//              label_content = "Made by: " + master_list[i].who + "<br>On: " + when.toDateString();
              var marker = new MarkerWithLabel({
                position: new google.maps.LatLng(0,0),
                labelAnchor: new google.maps.Point(30, 20),
                draggable: false,
                raiseOnDrag: false,
                map: map,
                labelContent: label_content,
                labelClass: "map_tooltip", // the CSS class for the label - in this doc - needed?
                labelStyle: {opacity: 1.0},
                icon: "http://placehold.it/1x1",
                visible: false
              });

              google.maps.event.addListener(poly, "mousemove", function(event) {
                marker.setPosition(event.latLng);
                marker.setVisible(true);
              });

              google.maps.event.addListener(poly, "mouseout", function(event) {
                marker.setVisible(false);
              });

            }

          }

        }

        // Get the google XLS data as CSV, put it all in a array of objects
        $.get('backend.py',function( data ) {
          var declared_count = 0;
          line_list = data.split("\n");
          var total_num_las = line_list.length;
          for (i = 1; i < total_num_las; i++) {
            line_parts = line_list[i].split(",");
            if (line_parts[1] === "Yes") {
              declared_count++;
            }
            var la_object = {
              area: line_parts[0],
              declared: line_parts[1],
              who: line_parts[2],
              when: line_parts[3],
              logoURL: line_parts[4],
              geometry: null
            };
            master_list.push(la_object);
          }

          // Update stats counts
          $("#declared_count").html(declared_count);
          $("#percentage").html(Math.round((declared_count / total_num_las)*100));

          // Now get the big blob of geojson and add to the master list
          $.getJSON( "la_boundaries.geojson", function( data ) {
            num_areas = data["features"].length
            for (i = 0; i < num_areas; i++) { 
              area = data["features"][i]["properties"]["lad17nm"];
              for (j = 0; j < master_list.length; j++) {
                if (master_list[j].area == area) {
                  // Convert coordinates and store
                  geo_list = Array();
                  type = data["features"][i]["geometry"].type;

// STILL GOT A MULTIPOLYGON ISSUE HERE

                  if (type === "Polygon") {
                    for (k = 0; k < data["features"][i]["geometry"]["coordinates"][0].length; k++) {
                      latlong_pair = {
                        lat: data["features"][i]["geometry"]["coordinates"][0][k][1],
                        lng: data["features"][i]["geometry"]["coordinates"][0][k][0]
                      }
                      geo_list.push(latlong_pair);
                    }
                    master_list[j].geometry = geo_list;
                  }
                break;
                }
              }
            }

            createMap();

          });

        });

      });
    </script>
  </head>
  <body>
    <center>
      <h1>Local Gov Digital Declaration Mao</h1>
      <h3>Data stored <a href="https://goo.gl/BxcSFo">in this google sheet</a>.</h3>
      <h3>So far <span id="declared_count"></span> local authories have signed the Declaration which is <span id="percentage"></span>%</h3>
<h3 style="color: red; font-weight: bold">To do: Move mouse-over pic and text to side of map (bootstrap), support for MultiPolygon and cloud hosting</h3>
      <p>
      <style>
       /* Set the size of the div element that contains the map */
        #map-canvas {
          height: 80%;  /* The height is 400 pixels */
          width: 50%;  /* The width is the width of the web page */
        }
      </style>
      <div id="map-canvas"></div>

    </center>
  </body>
</html>
